name: ðŸ‰ â€¢ Tests
on:
  workflow_call:

jobs:
  mlir:
    name: >-
      ${{ contains(matrix.os, 'ubuntu') && 'ðŸ§' || contains(matrix.os, 'windows') && 'ðŸ' || 'ðŸŽ' }}
      ${{ matrix.coverage && 'Coverage' || matrix.os }} with LLVM@${{ matrix.llvm-version }}
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        os:
          [
            ubuntu-24.04,
            ubuntu-24.04-arm,
            macos-15-intel,
            macos-15,
            windows-2025,
            windows-11-arm,
          ]
        llvm-version: [21]
        coverage: [false]
        include:
          - os: ubuntu-24.04
            llvm-version: 21
            coverage: true
    env:
      CMAKE_BUILD_PARALLEL_LEVEL: 4
      CTEST_PARALLEL_LEVEL: 4
      FORCE_COLOR: 3
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0

      # OS-specific toolchain setup
      - name: Download archives (macos-15)
        if: ${{ matrix.os == 'macos-15' }}
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          artifact-ids: 4523730758
          path: llvm-project
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: burgholzer/portable-mlir-toolchain
          run-id: 19238113674

      - name: Setup LLVM/MLIR (macos-15)
        if: ${{ matrix.os == 'macos-15' }}
        run: |
          cd llvm-project

          # Extract archive
          zstd -d llvm-mlir_21.1.5_macos_arm64_AArch64_opt.tar.zst --output-dir-flat .
          tar xf llvm-mlir_21.1.5_macos_arm64_AArch64_opt.tar

          # Set environment variable for subsequent steps
          echo "LLVM_DIR=$PWD/lib/cmake/llvm" >> $GITHUB_ENV
          echo "PATH=$PWD/bin:$PATH" >> $GITHUB_ENV

      - name: Download archives (macos-15-intel)
        if: ${{ matrix.os == 'macos-15-intel' }}
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          artifact-ids: 4524467391
          path: llvm-project
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: burgholzer/portable-mlir-toolchain
          run-id: 19238113674

      - name: Setup LLVM/MLIR (macos-15-intel)
        if: ${{ matrix.os == 'macos-15-intel' }}
        run: |
          cd llvm-project

          # Extract archive
          zstd -d llvm-mlir_21.1.5_macos_x86_64_X86_opt.tar.zst --output-dir-flat .
          tar xf llvm-mlir_21.1.5_macos_x86_64_X86_opt.tar

          # Set environment variable for subsequent steps
          echo "LLVM_DIR=$PWD/lib/cmake/llvm" >> $GITHUB_ENV
          echo "PATH=$PWD/bin:$PATH" >> $GITHUB_ENV

      - name: Download archives (ubuntu-24.04)
        if: ${{ matrix.os == 'ubuntu-24.04' }}
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          artifact-ids: 4522900817
          path: llvm-project
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: burgholzer/portable-mlir-toolchain
          run-id: 19238113653

      - name: Setup LLVM/MLIR (ubuntu-24.04)
        if: ${{ matrix.os == 'ubuntu-24.04' }}
        run: |
          cd llvm-project

          # Extract archive
          zstd -d llvm-mlir_llvmorg-21.1.5_linux_x86_64_X86_opt.tar.zst --output-dir-flat .
          tar xf llvm-mlir_llvmorg-21.1.5_linux_x86_64_X86_opt.tar

          # Set environment variable for subsequent steps
          echo "LLVM_DIR=$PWD/lib/cmake/llvm" >> $GITHUB_ENV
          echo "PATH=$PWD/bin:$PATH" >> $GITHUB_ENV

      - name: Download archives (ubuntu-24.04-arm)
        if: ${{ matrix.os == 'ubuntu-24.04-arm' }}
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          artifact-ids: 4522477446
          path: llvm-project
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: burgholzer/portable-mlir-toolchain
          run-id: 19238113653

      - name: Setup LLVM/MLIR (ubuntu-24.04-arm)
        if: ${{ matrix.os == 'ubuntu-24.04-arm' }}
        run: |
          cd llvm-project

          # Extract archive
          zstd -d llvm-mlir_llvmorg-21.1.5_linux_aarch64_AArch64_opt.tar.zst --output-dir-flat .
          tar xf llvm-mlir_llvmorg-21.1.5_linux_aarch64_AArch64_opt.tar

          # Set environment variable for subsequent steps
          echo "LLVM_DIR=$PWD/lib/cmake/llvm" >> $GITHUB_ENV
          echo "PATH=$PWD/bin:$PATH" >> $GITHUB_ENV

      - name: Download archives (windows-2025)
        if: ${{ matrix.os == 'windows-2025' }}
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          artifact-ids: 4523623862
          path: llvm-project
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: burgholzer/portable-mlir-toolchain
          run-id: 19238113657

      - name: Setup LLVM/MLIR (windows-2025)
        if: ${{ matrix.os == 'windows-2025' }}
        run: |
          choco install -y zstandard

          cd llvm-project

          # Extract archive
          zstd -d llvm-mlir_21.1.5_windows_x86_64_X86_opt.tar.zst --output-dir-flat .
          tar xf llvm-mlir_21.1.5_windows_x86_64_X86_opt.tar

          # Set environment variable for subsequent steps
          echo "LLVM_DIR=${{ github.workspace }}\lib\cmake\llvm" >> $GITHUB_ENV
          echo "PATH=${{ github.workspace }}\bin;$PATH" >> $GITHUB_ENV

      - name: Download archives (windows-11-arm)
        if: ${{ matrix.os == 'windows-11-arm' }}
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          artifact-ids: 4523008960
          path: llvm-project
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: burgholzer/portable-mlir-toolchain
          run-id: 19238113657

      - name: Setup LLVM/MLIR (windows-11-arm)
        if: ${{ matrix.os == 'windows-11-arm' }}
        run: |
          choco install -y zstandard

          cd llvm-project

          # Extract archive
          zstd -d llvm-mlir_21.1.5_windows_x86_64_X86_opt.tar.zst --output-dir-flat .
          tar xf llvm-mlir_21.1.5_windows_x86_64_X86_opt.tar

          # Set environment variable for subsequent steps
          echo "LLVM_DIR=${{ github.workspace }}\lib\cmake\llvm" >> $GITHUB_ENV
          echo "PATH=${{ github.workspace }}\bin;$PATH" >> $GITHUB_ENV

      # Build acceleration and Python tooling
      - name: Set up mold as linker (Linux)
        uses: rui314/setup-mold@725a8794d15fc7563f59595bd9556495c0564878 # v1

      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@85856786d1ce8acfbcc2f13a5f3fbd6b938f9f41 # v7.1.2
        with:
          python-version: 3.13
          activate-environment: true
          enable-cache: false
          restore-cache: false
          save-cache: ${{ github.ref == 'refs/heads/main' }}

      - name: Install Ninja
        run: uv tool install ninja

      - name: Install lit
        run: uv pip install lit

      # Configure
      - name: Configure CMake (Linux and macOS)
        if: runner.os == 'Linux' || runner.os == 'macOS'
        run: |
          cmake -G Ninja -S . -B build \
            -DCMAKE_BUILD_TYPE=${{ matrix.coverage && 'Debug' || 'Release' }} \
            -DBUILD_MQT_CORE_MLIR=ON \
            -DLLVM_DIR=$LLVM_DIR \
            -DMLIR_DIR=$MLIR_DIR \
            -DLLVM_EXTERNAL_LIT=$(which lit) \
            ${{ matrix.coverage && '-DENABLE_COVERAGE=ON' || '' }}

      - name: Configure CMake (Windows)
        if: runner.os == 'Windows'
        run: |
          cmake -S . -B build `
            -DCMAKE_BUILD_TYPE=${{ matrix.coverage && 'Debug' || 'Release' }} `
            -DBUILD_MQT_CORE_MLIR=ON `
            -DLLVM_DIR="${{ github.workspace }}\llvm-install\lib\cmake\llvm" `
            -DMLIR_DIR="${{ github.workspace }}\llvm-install\lib\cmake\mlir" `
            -DLLVM_EXTERNAL_LIT=${{ github.workspace }}\.venv\Scripts\lit.exe `
            ${{ matrix.coverage && '-DENABLE_COVERAGE=ON' || '' }}

      # Build
      - name: Build MLIR lit target
        run: cmake --build build --config ${{ matrix.coverage && 'Debug' || 'Release' }} --target mqt-core-mlir-lit-test-build-only

      - name: Build MLIR unittests
        run: cmake --build build --config ${{ matrix.coverage && 'Debug' || 'Release' }} --target mqt-core-mlir-translation-test

      # Test
      - name: Run lit tests
        run: cmake --build build --config ${{ matrix.coverage && 'Debug' || 'Release' }} --target mqt-core-mlir-lit-test

      - name: Run unit tests
        run: ctest -C ${{ matrix.coverage && 'Debug' || 'Release' }} --output-on-failure --test-dir build/mlir --repeat until-pass:3 --timeout 600

      # Coverage
      - name: Generate coverage data as JSON (gcovr)
        if: matrix.coverage
        run: |
          uvx gcovr \
             --gcov-executable "/usr/lib/llvm-${{ matrix.llvm-version }}/bin/llvm-cov gcov" \
             --exclude build \
             --exclude-unreachable-branches \
             --exclude-noncode-lines \
             --exclude-throw-branches \
             --print-summary \
             --keep \
             --json \
             -o coverage-llvm-${{ matrix.llvm-version }}.json

      - name: Upload coverage to Codecov
        if: matrix.coverage
        uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7 # v5.5.1
        with:
          flags: mlir
          name: mlir-coverage-llvm-${{ matrix.llvm-version }}
          fail_ci_if_error: true
          use_oidc: true
          files: coverage-llvm-${{ matrix.llvm-version }}.json
